<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd">

    <changeSet id="044-add-checkin-date" author="mindrevol">
        <addColumn tableName="checkins">
            <column name="checkin_date" type="DATE"/>
        </addColumn>

        <sql>
            UPDATE checkins SET checkin_date = DATE(created_at) WHERE checkin_date IS NULL;
        </sql>

        <sql>
            DELETE FROM checkin_reactions
            WHERE checkin_id IN (
                SELECT c1.id FROM checkins c1
                JOIN checkins c2 ON c1.user_id = c2.user_id 
                    AND c1.journey_id = c2.journey_id 
                    AND c1.checkin_date = c2.checkin_date
                WHERE c1.id &lt; c2.id
            );
        </sql>

        <sql>
            DELETE FROM checkin_comments
            WHERE checkin_id IN (
                SELECT c1.id FROM checkins c1
                JOIN checkins c2 ON c1.user_id = c2.user_id 
                    AND c1.journey_id = c2.journey_id 
                    AND c1.checkin_date = c2.checkin_date
                WHERE c1.id &lt; c2.id
            );
        </sql>
        
        <sql>
            DELETE FROM checkin_verifications
            WHERE checkin_id IN (
                SELECT c1.id FROM checkins c1
                JOIN checkins c2 ON c1.user_id = c2.user_id 
                    AND c1.journey_id = c2.journey_id 
                    AND c1.checkin_date = c2.checkin_date
                WHERE c1.id &lt; c2.id
            );
        </sql>

        <sql>
            DELETE FROM checkins c1
            USING checkins c2
            WHERE c1.id &lt; c2.id
            AND c1.user_id = c2.user_id
            AND c1.journey_id = c2.journey_id
            AND c1.checkin_date = c2.checkin_date;
        </sql>

        <addNotNullConstraint tableName="checkins" columnName="checkin_date" columnDataType="DATE"/>

        <addUniqueConstraint tableName="checkins"
                             columnNames="user_id, journey_id, checkin_date"
                             constraintName="uk_checkin_user_journey_date"/>
    </changeSet>

</databaseChangeLog>