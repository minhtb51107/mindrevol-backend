<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd">
    <changeSet id="004-create-checkins-v2" author="mindrevol">
        <createTable tableName="checkins">
            <column name="id" type="BIGINT" autoIncrement="true"><constraints primaryKey="true"/></column>
            <column name="user_id" type="BIGINT"><constraints nullable="false" foreignKeyName="fk_checkin_user" referencedTableName="users" referencedColumnNames="id"/></column>
            <column name="journey_id" type="BIGINT"><constraints nullable="false" foreignKeyName="fk_checkin_journey" referencedTableName="journeys" referencedColumnNames="id"/></column>
            <column name="caption" type="TEXT"/>
            <column name="image_url" type="VARCHAR(255)"/>
            <column name="thumbnail_url" type="VARCHAR(255)"/>
            <column name="emotion" type="VARCHAR(50)"/>
            <column name="status" type="VARCHAR(20)" defaultValue="NORMAL"><constraints nullable="false"/></column>
            <column name="visibility" type="VARCHAR(20)" defaultValue="PUBLIC"><constraints nullable="false"/></column>
            <column name="checkin_date" type="DATE"><constraints nullable="false"/></column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP"><constraints nullable="false"/></column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="created_by" type="BIGINT"/>
            <column name="last_modified_by" type="BIGINT"/>
            <column name="deleted_at" type="TIMESTAMP WITH TIME ZONE"/>
        </createTable>
        <addUniqueConstraint columnNames="user_id, journey_id, checkin_date" constraintName="uk_checkin_user_journey_date" tableName="checkins"/>
        <createIndex indexName="idx_checkin_journey" tableName="checkins"><column name="journey_id"/></createIndex>
        <createIndex indexName="idx_checkin_user" tableName="checkins"><column name="user_id"/></createIndex>
    </changeSet>
    <changeSet id="004-create-checkin-comments" author="mindrevol">
        <createTable tableName="checkin_comments">
            <column name="id" type="BIGINT" autoIncrement="true"><constraints primaryKey="true"/></column>
            <column name="checkin_id" type="BIGINT"><constraints nullable="false" foreignKeyName="fk_comment_checkin" referencedTableName="checkins" referencedColumnNames="id"/></column>
            <column name="user_id" type="BIGINT"><constraints nullable="false" foreignKeyName="fk_comment_user" referencedTableName="users" referencedColumnNames="id"/></column>
            <column name="content" type="TEXT"><constraints nullable="false"/></column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP"><constraints nullable="false"/></column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="created_by" type="BIGINT"/>
            <column name="last_modified_by" type="BIGINT"/>
            <column name="deleted_at" type="TIMESTAMP WITH TIME ZONE"/>
        </createTable>
    </changeSet>
    <changeSet id="004-create-checkin-reactions" author="mindrevol">
        <createTable tableName="checkin_reactions">
            <column name="id" type="BIGINT" autoIncrement="true"><constraints primaryKey="true"/></column>
            <column name="checkin_id" type="BIGINT"><constraints nullable="false" foreignKeyName="fk_reaction_checkin" referencedTableName="checkins" referencedColumnNames="id"/></column>
            <column name="user_id" type="BIGINT"><constraints nullable="false" foreignKeyName="fk_reaction_user" referencedTableName="users" referencedColumnNames="id"/></column>
            <column name="emoji" type="VARCHAR(50)"><constraints nullable="false"/></column>
            <column name="media_url" type="VARCHAR(255)"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP"><constraints nullable="false"/></column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="created_by" type="BIGINT"/>
            <column name="last_modified_by" type="BIGINT"/>
            <column name="deleted_at" type="TIMESTAMP WITH TIME ZONE"/>
        </createTable>
        <addUniqueConstraint columnNames="checkin_id, user_id" constraintName="uk_reaction_checkin_user" tableName="checkin_reactions"/>
    </changeSet>
    <changeSet id="004-create-checkin-verifications" author="mindrevol">
        <createTable tableName="checkin_verifications">
            <column name="id" type="BIGINT" autoIncrement="true"><constraints primaryKey="true"/></column>
            <column name="checkin_id" type="BIGINT"><constraints nullable="false" foreignKeyName="fk_verification_checkin" referencedTableName="checkins" referencedColumnNames="id"/></column>
            <column name="voter_id" type="BIGINT"><constraints nullable="false" foreignKeyName="fk_verification_voter" referencedTableName="users" referencedColumnNames="id"/></column>
            <column name="is_approved" type="BOOLEAN"><constraints nullable="false"/></column>
            <column name="feedback" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP"><constraints nullable="false"/></column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="created_by" type="BIGINT"/>
            <column name="last_modified_by" type="BIGINT"/>
            <column name="deleted_at" type="TIMESTAMP WITH TIME ZONE"/>
        </createTable>
        <addUniqueConstraint columnNames="checkin_id, voter_id" constraintName="uk_verification_checkin_voter" tableName="checkin_verifications"/>
    </changeSet>
</databaseChangeLog>